const Promise = require('bluebird');
const fs = require('fs');
const readFileAsync = Promise.promisify(fs.readFile, fs);
const path = require('path');
const config = require('../config');

const hibiku = require('./hibiku');

function engine(app) {
    
    app.engine(config.engine.extension, function(path, options, fn) {
        readFileAsync(path, 'utf-8').then(function(data) {
            options['_view'] = path;
            return fn(null, hibiku.render(data, options));
        });
    });
    
    app.set('views', config.engine.views);
    app.set('view engine', config.engine.extension.slice(1));
    
}

module.exports = {
    use: engine
}