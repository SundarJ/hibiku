const express = require('express');
const app = express();
const bodyParser = require('body-parser');
const path = require('path');

const config = require('./config');
const utils = require('./utils');

const engine = require('./engine/');
engine.use(app);

app.disable('x-powered-by');

var template = {
    'index': {
        'main title': 'Yo',
        'main content area': 'peace'
    },
    'hibiku-editor': {
        files: ['a','b','c', 'd']
    }
}

app.get('/', function(req, res, next) {
    return res.render(config.options.frontPage, template[config.options.frontPage]);
    next();
});

var routes = [];
config.engine.views.forEach(function(directory) {
    utils.walk(directory, function(f, s) {
        if (f.indexOf(config.root) > -1)
            routes.push(f.replace(config.root, ''));
        else
            routes.push(f.replace(directory, ''));
    });
});

routes.forEach(function(route) {
    
    route = route.replace(config.engine.extension, '');
    var hook = path.basename(route);
    if (route.indexOf('/bts/') === 0)
        route = route.replace(/pages\/(hibiku-)?/, '');
    
    app.get(route, function(req, res, next) {
        return res.render(hook, template[hook]);
        next();
    });
    
});

app.use(express.static(config.root));
app.use(express.static(config.userRoot));

app.use(function(req, res) {
    res.status(404).render('404', { url: req.url });
});


module.exports = {
    listen: function(port, ip) {
        console.log('\n  hibiku now listening to', ip+':'+port, '\n');
        app.listen(port, ip);
    },
    app: app
}
