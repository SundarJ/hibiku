const express = require('express');
const app = express();
const bodyParser = require('body-parser');
const path = require('path');

const Promise = require('bluebird');

const config = require('./config');
const utils = require('./utils');

const engine = require('./engine/');
engine.use(app);

app.disable('x-powered-by');

var template = {
    'index': {
        'main title': 'Yo',
        'main content area': 'peace'
    },
    'hibiku-editor': {
        files: []
    }
};

app.get('/', function(req, res, next) {
    return res.render(config.user.options.frontPage, template[config.user.options.frontPage]);
    next();
});

const api = require('./api');
api.use(app);

var viewFiles = [], routes = [];
Promise.each(config.engine.views, function(view) {
    return utils.walk(view).then(function(files) {
        files.forEach(function(file) {
            if (file.indexOf(config.root) > -1) {
                routes.push(file.replace(config.root, ''));
            } else {
                viewFiles.push(file.replace(config.user.root, '').replace(new RegExp(config.engine.extension + "$"), ''));
                routes.push(file.replace(view, ''));
            }
        });
    });
}).then(function() {
    template['hibiku-editor'].files = viewFiles;
    
    routes.forEach(function(route) {
        route = route.replace(config.engine.extension, '');
        var hook = path.basename(route);
        if (route.indexOf('/bts/') === 0) {
            route = route.replace(/pages\/(hibiku-)?/, '');
        } else {
            var parts = route.split(path.sep).slice(1);
            if (parts.length > 1) {
                hook = parts.join(path.sep); // hook for folders (ie. path/to/filename instead of just filename)
            }
        }
        
        app.get(route, function(req, res, next) {
            return res.render(hook, template[hook]);
        });

    });
    
    app.use(express.static(config.root));
    app.use(express.static(config.user.root));
    
    app.use(function(req, res) {
        res.status(404).render('404', { url: req.url });
    });
});


module.exports = {
    listen: function(port, ip) {
        console.log('\n  hibiku now listening to', (ip || '')+':'+port, '\n');
        app.listen(port, ip);
    },
    app: app
}
