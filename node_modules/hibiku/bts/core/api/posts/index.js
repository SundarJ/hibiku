const Promise = require('bluebird');
const db = require('../../db');

const JSCK = require('jsck');
const fs = require('fs');
const path = require('path');

const parse = require('co-body');

const schema = JSON.parse(fs.readFileSync(path.join(__dirname,'schema.json'), 'utf-8'));
const jsck = new JSCK.draft4(schema);

module.exports = function* () {
    if (this.request.accepts('json') && this.request.is('json')) {
        const body = yield parse.json(this.request.body);
        var validated = jsck.validate(body);
        if (validated.valid) {
            db.setup().then(function() {
                console.log('success'); 
            });
            this.body = validated;
        } else {
            this.status = 400;
            this.body = {
                error: "bad request",
                jsck: validated
            };
        }
    } else {
        this.status = 400;
        this.body = {"error": "bad request"};
    }
};
