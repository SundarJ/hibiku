const JSCK = require('jsck');
const fs = require('fs');
const path = require('path');

const config = require('../../../config');
const utils = require('../../../utils');

const schema = JSON.parse(fs.readFileSync(path.join(__dirname,'schema.json'), 'utf-8'));
const jsck = new JSCK.draft4(schema);

module.exports = function(req, res) {
    var valid = jsck.validate(req.body);
    if (valid.valid) {
        var file = path.join(config.user.root, req.body.file);
        if (!~file.indexOf(config.root)) {
            var data = fs.readFileSync(file, 'utf-8');
            
            data = data.split("\n").map(function(line) {
                var tags = line.match(/\(\([^]+?\)\)/g);
                if (tags)
                    return tags[0].replace(/[\(\)]/g, '');
            }).filter(utils.filter.truthy).filter(function(i) { return i[0] != '>'});
            res.end(JSON.stringify(data));
            
        } else {
            res.status(403);
            res.end('{"error": "forbidden"}');
        }
    }
};